name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.0)'
        required: true
        default: 'v1.2.0'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Cache Flutter dependencies
      uses: actions/cache@v3
      with:
        path: /opt/hostedtoolcache/flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

    - name: Get dependencies
      run: flutter pub get

    - name: Run analyze
      run: flutter analyze --no-fatal-infos

    - name: Run tests
      run: flutter test

    - name: Build Android APK
      run: flutter build apk --release --verbose

    - name: Build Android App Bundle
      run: flutter build appbundle --release --verbose

    - name: Get version from tag or input
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release Archive
      run: |
        mkdir -p release
        VERSION=${{ steps.version.outputs.version }}
        cp build/app/outputs/flutter-apk/app-release.apk release/MoneyG-Android-${VERSION}.apk
        cp build/app/outputs/bundle/release/app-release.aab release/MoneyG-Android-${VERSION}.aab
        cd release
        zip -r MoneyG-Android-${VERSION}.zip MoneyG-Android-${VERSION}.apk
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
        echo "## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±" > ../release_info.md
        echo "| ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º | SHA256 |" >> ../release_info.md
        echo "|----------|--------|---------|" >> ../release_info.md
        for file in *.apk *.aab *.zip; do
          if [ -f "$file" ]; then
            size=$(du -h "$file" | cut -f1)
            hash=$(sha256sum "$file" | cut -d' ' -f1)
            echo "| $file | $size | \`$hash\` |" >> ../release_info.md
          fi
        done
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/MoneyG-Android-${{ steps.version.outputs.version }}.apk
          release/MoneyG-Android-${{ steps.version.outputs.version }}.aab
          release/MoneyG-Android-${{ steps.version.outputs.version }}.zip
        name: 'Money:G ${{ steps.version.outputs.version }}'
        body: |
          ## ğŸ‰ Money:G ${{ steps.version.outputs.version }} ãƒªãƒªãƒ¼ã‚¹
          
          ### ğŸ“± ä¸»ãªæ©Ÿèƒ½
          - ğŸ“Š å®¶è¨ˆç°¿ç®¡ç†ï¼ˆåå…¥ãƒ»æ”¯å‡ºï¼‰
          - ğŸ“ˆ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ»è³‡ç”£åˆ†æ
          - ğŸ’¾ CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          - ğŸ’° äºˆç®—ç®¡ç†ãƒ»NISAç®¡ç†
          - ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
          - âš¡ ã‚¯ã‚¤ãƒƒã‚¯ç™»éŒ²
          - ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ
          
          ### ğŸ“‹ v1.2.0ã®æ–°æ©Ÿèƒ½
          - âœ¨ **CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½**: ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ˜ç´°ç­‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½
          - ğŸ¨ **Material Designçµ±ä¸€**: iOSãƒ†ãƒ¼ãƒã‚’å‰Šé™¤ã—ã¦UIã‚’çµ±ä¸€
          - ğŸ  **æ–°ã—ã„æ”¯å‡ºã‚«ãƒ†ã‚´ãƒª**: å®¶è³ƒã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
          - ğŸ› **ãƒã‚°ä¿®æ­£**: ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ã§ã®ä¿å­˜å¾Œãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå•é¡Œã‚’ä¿®æ­£
          
          ### ğŸ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - **APK** (`MoneyG-Android-${{ steps.version.outputs.version }}.apk`): ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨
          - **AAB** (`MoneyG-Android-${{ steps.version.outputs.version }}.aab`): Google Play Storeç”¨
          - **ZIP** (`MoneyG-Android-${{ steps.version.outputs.version }}.zip`): APKåœ§ç¸®ç‰ˆ
          
          $(cat release_info.md)
          
          ### ğŸ“± ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          1. **APKãƒ•ã‚¡ã‚¤ãƒ«**ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. Androidç«¯æœ«ã®**è¨­å®š > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ã§ã€Œæä¾›å…ƒä¸æ˜ã®ã‚¢ãƒ—ãƒªã€ã‚’è¨±å¯
          3. APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          4. å¿…è¦ã«å¿œã˜ã¦æ¨©é™ã‚’è¨±å¯
          
          ### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          - ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯å…¬å¼GitHub Actionsã§è‡ªå‹•ãƒ“ãƒ«ãƒ‰
          - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯å®Œå…¨ã«ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹
          - ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼æº–æ‹ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰
          
          ### ğŸ› å•é¡Œã‚’ç™ºè¦‹ã—ãŸå ´åˆ
          - [Issues](https://github.com/paraccoli/flutter_finance_app/issues)ã§ãƒã‚°å ±å‘Š
          - [Discussions](https://github.com/paraccoli/flutter_finance_app/discussions)ã§è³ªå•ãƒ»ææ¡ˆ
          
          ### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - [README.md](README.md): ã‚¢ãƒ—ãƒªã®æ¦‚è¦ã¨ä½¿ã„æ–¹
          - [PRIVACY.md](PRIVACY.md): ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
          - [LICENSE](LICENSE): MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update release info
      if: success()
      run: |
        echo "âœ… ãƒªãƒªãƒ¼ã‚¹ ${{ steps.version.outputs.version }} ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
        echo "ğŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
